# ES Web Analytics
A fully customizable and private page view web analytics solution based on Kotlin / Quarkus (native & JVM), Elasticsearch and Kibana (optionally).

![Page Views Dashboard](https://raw.githubusercontent.com/soufianesakhi/es-web-analytics/master/screenshots/page-views-dashboard.png)

## Architecture

The core component of this solution is a Kotlin / Quarkus app that exposes an API to track page views. The app is built in two formats:
- Native executable (GraalVM)
- Jar (JDK)

After receiving a request, the app parses the headers and query parameters, generates relevant data and sends the end result to Elasticsearch.

The app also sends performance data such as heap memory usage and garbage collection metrics to Elasticsearch.

The user can either use Kibana or another visualizations solution that supports Elasticsearch to display the page view and performance dashboards.

A docker-compose solution example is provided to demonstrate how ES Web Analytics can be used.

## API

### GET or POST /pageview?{query-params}

Used to parse the request headers and query parameters, generate additional fields and send them to Elasticsearch.

By default, all the request's query parameters will be sent to Elasticsearch untouched in addition to the following generated fields except when noted:

| Field         | Source                                             | Comment                        |
| ------------- | -------------------------------------------------- | ------------------------------ |
| ip            | Request remote address, "ip" query parameter       | Can be removed                 |
| date          | Request processing instant, "date" query parameter |                                |
| page          | "Referer" header, "page" query parameter           |                                |
| referer       | "referer" query parameter                          |                                |
| refererDomain | "referer" query parameter                          | Only when "referer" is present |
| country       | "ip" field                                         |                                |
| continent     | "ip" field                                         |                                |
| device        | "User-Agent" header                                | Desktop / Phone / Tablet       |
| browserName   | "User-Agent" header                                |                                |
| browser       | "User-Agent" header                                | Includes the browser version   |
| os            | "User-Agent" header                                |                                |

The query parameters always take precedence when multiple sources are possible.

### GET /pageview/dryrun?{query-params}
Similar to the `/pageview` endpoint without sending the data to Elasticsearch, the data will be returned in the response instead.

## Installation and configuration

The app is packaged as a docker image and is published in the following Docker Hub repository:
[soufianesakhi/es-web-analytics](https://hub.docker.com/repository/docker/soufianesakhi/es-web-analytics).

A command example to run the docker image is as follows:
```bash
docker run -p 8080:8080 -e JAVA_OPTS="-Xmx256m" -v <LOCAL_CONFIG_FOLDER>:/app/config -v <LOCAL_LOGS_FOLDER>:/app/logs -t soufianesakhi/es-web-analytics:latest
```

The `LOCAL_LOGS_FOLDER` directory will contain the logs generated by the app.

The `LOCAL_CONFIG_FOLDER` directory must contain an `elasticsearch.json` file to configure elasticsearch instances where the data will be sent. It's formatted as follows:
```json
{
  "page_views": [
    {
      "username": "elastic",
      "password": "changeme",
      "hostname": "elasticsearch",
      "port": 9200,
      "scheme": "http",
      "index": "pageviews"
    }
  ],
  "performance": [
    {
      "username": "elastic",
      "password": "changeme",
      "hostname": "elasticsearch",
      "port": 9200,
      "scheme": "http",
      "index": "performance"
    }
  ]
}
```

The `JAVA_OPTS` environnement variable can be used to specify custom Java flags and properties.

The following properties can be used to specifically customize the app:
- `-Danalytics.include-ip=<true/false>`: To remove the ip field from the data sent to Elasticsearch
- `-Delasticsearch.index.append-date=<true/false>`: Whether the date (yyyy-MM-dd) should be appended to the index name
- `-Dmonitoring.performance.enabled=<true/false>`: To enable / disable the app's performance monitoring

### Alternative packaging
For various reasons (such as benchmarking), the following JVM docker image tags are also built and published to Docker Hub:
- `soufianesakhi/es-web-analytics-jvm:latest`: Uses Quarkus
- `soufianesakhi/es-web-analytics-jvm:1.0.0`: Uses Spring Boot

A standalone jar can also be built by running `./gradlew build` from the root of the project.

## Demo
The following demo will present an example deployment of the solution using docker-compose.

This solution uses in addition to ES Web Analytics:
- A standard Kibana Docker image
- A custom Elasticsearch Docker image containing pre-initialized Kibana Dashboards

### Requirements
- [Docker](https://www.docker.com/products/docker-desktop)
- [Docker compose](https://docs.docker.com/compose/install/)

### Deployment
To launch the solution, run from the command line in the project's root directory:
```bash
docker-compose up
```
Wait for the solution to be ready:

![Docker-compose startup](https://raw.githubusercontent.com/soufianesakhi/es-web-analytics/master/screenshots/docker-compose-startup.png)

You can now test the API.

### Testing
If you are using Docker Toolbox, the solution will be exposed to a custom ip (and not to localhost). You can find this ip by executing:
```bash
docker-machine ip
```

The API can be reached from: `http://<DOCKER_HOST>:8080` 

Kibana can be opened in your browser using the url: `http://<DOCKER_HOST>:5601`

Where `<DOCKER_HOST> = localhost or docker-machine ip`

To simulate a real use-case of the API, launch the following command from the root of the project (linux shell with curl is required):
```bash
./.data/sample_requests.sh http://<DOCKER_HOST>:8080
```

If you navigate now to the Kibana Page Views Dashboard, you will find a filled dashboard similar to this:
![Page Views Dashboard](https://raw.githubusercontent.com/soufianesakhi/es-web-analytics/master/screenshots/page-views-dashboard.png)
